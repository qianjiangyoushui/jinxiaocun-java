<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Projects">
	
	<!-- 缓存条数 -->
	<cache size="2000" />
	
	<!-- 条件语句 -->
	<sql id="WhereSQL">
		<where>
			<if test="guid != null and guid != ''"> 
			AND T.GUID = #{guid} 
			</if>
			<if test="stockcompany != null and stockcompany != ''"> 
			AND T.STOCKCOMPANY = #{stockcompany} 
			</if>
			<if test="stockcompanyid != null and stockcompanyid != ''"> 
			AND T.STOCKCOMPANYID = #{stockcompanyid} 
			</if>
			<if test="supplycompany != null and supplycompany != ''"> 
			AND T.SUPPLYCOMPANY = #{supplycompany} 
			</if>
			<if test="supplycompanyid != null and supplycompanyid != ''"> 
			AND T.SUPPLYCOMPANYID = #{supplycompanyid} 
			</if>
			<if test="coaltype != null and coaltype != ''"> 
			AND T.COALTYPE = #{coaltype} 
			</if>
			<if test="coalquality != null and coalquality != ''"> 
			AND T.COALQUALITY = #{coalquality} 
			</if>
			<if test="starttime != null and starttime != ''"> 
			AND T.STARTTIME &gt;= #{starttime} 
			</if>
			<if test="endtime != null and endtime != ''"> 
			AND T.STARTTIME &lt;= #{endtime} 
			</if>
			<if test="camount != null and camount != ''"> 
			AND T.CAMOUNT = #{camount} 
			</if>
			<if test="unitprice != null and unitprice != ''"> 
			AND T.UNITPRICE = #{unitprice} 
			</if>
			<if test="managername != null and managername != ''"> 
			AND T.MANAGERNAME = #{managername} 
			</if>
			<if test="managerid != null and managerid != ''"> 
			AND T.MANAGERID = #{managerid} 
			</if>
			<if test="createdate != null and createdate != ''"> 
			AND T.CREATEDATE = #{createdate} 
			</if>
			<if test="operateid != null and operateid != ''"> 
			AND T.OPERATEID = #{operateid} 
			</if>
			<if test="companyid != null and companyid != ''"> 
			AND T.COMPANYID = #{companyid} 
			</if>
			<if test="del != null and del != ''"> 
			AND T.DEL = #{del} 
			</if>
			<if test="lastupdatetime != null and lastupdatetime != ''"> 
			AND T.LASTUPDATETIME = #{lastupdatetime} 
			</if>
		</where>
	</sql>
	
	<!-- 查找语句 -->
	<select id="find" resultType="Projects" parameterType="Projects" flushCache="false" useCache="true">
    	SELECT 
	    	T.GUID AS guid, 
	    	T.STOCKCOMPANY AS stockcompany, 
	    	T.STOCKCOMPANYID AS stockcompanyid, 
	    	T.SUPPLYCOMPANY AS supplycompany, 
	    	T.SUPPLYCOMPANYID AS supplycompanyid, 
	    	T.COALTYPE AS coaltype, 
	    	T.COALQUALITY AS coalquality, 
	    	T.STARTTIME AS starttime, 
	    	T.ENDTIME AS endtime, 
	    	T.CAMOUNT AS camount, 
	    	T.UNITPRICE AS unitprice, 
	    	T.MANAGERNAME AS managername, 
	    	T.MANAGERID AS managerid, 
	    	T.CREATEDATE AS createdate, 
	    	T.OPERATEID AS operateid, 
	    	T.COMPANYID AS companyid, 
	    	T.DEL AS del, 
	    	T.LASTUPDATETIME AS lastupdatetime 
    	FROM projects T
		<include refid="WhereSQL" />
		ORDER BY T.STARTTIME DESC 
	</select>
	
	
	<!-- 查找语句 -->
	<select id="finds" resultType="Projects" parameterType="Projects" flushCache="false" useCache="true">
    	SELECT 
	    	T.GUID AS guid, 
	    	T.STOCKCOMPANY AS stockcompany, 
	    	T.STOCKCOMPANYID AS stockcompanyid, 
	    	T.SUPPLYCOMPANY AS supplycompany, 
	    	T.SUPPLYCOMPANYID AS supplycompanyid, 
	    	T.COALTYPE AS coaltype, 
	    	T.COALQUALITY AS coalquality, 
	    	T.STARTTIME AS starttime, 
	    	T.ENDTIME AS endtime, 
	    	T.CAMOUNT AS camount, 
	    	T.UNITPRICE AS unitprice, 
	    	T.MANAGERNAME AS managername, 
	    	T.MANAGERID AS managerid, 
	    	T.CREATEDATE AS createdate, 
	    	T.OPERATEID AS operateid, 
	    	T.COMPANYID AS companyid, 
	    	T.DEL AS del, 
	    	T.LASTUPDATETIME AS lastupdatetime ,
	    	c.shortname as companyname 
    	FROM projects T 
    	left join company c 
    	on T.companyid = c.guid 
		<include refid="WhereSQL" />
		ORDER BY T.STARTTIME DESC 
	</select>
	
	
	<!-- 税票登记查找语句 -->
	<select id="spfind" resultMap="settlementWithProjects" parameterType="Projects" flushCache="false" >
    	SELECT 
	    	T.guid AS guid, 
	    	T.stockcompany AS stockcompany, 
	    	T.stockcompanyid AS stockcompanyid, 
	    	T.supplycompany AS supplycompany, 
	    	T.supplycompanyid AS supplycompanyid, 
	    	T.coaltype AS coaltype, 
	    	T.coalquality AS coalquality, 
	    	T.starttime AS starttime, 
	    	T.endtime AS endtime, 
	    	T.camount AS camount, 
	    	T.unitprice AS unitprice, 
	    	T.managername AS managername, 
	    	T.managerid AS managerid, 
	    	T.createdate AS createdate, 
	    	T.operateid AS operateid, 
	    	T.companyid AS companyid, 
	    	T.del AS del, 
	    	T.lastupdatetime AS lastupdatetime,
	    	S.guid AS s_guid, 
	    	S.startdate AS s_startdate, 
	    	S.enddate AS s_enddate, 
	    	S.createdate AS s_createdate, 
	    	S.lastupdatetime AS s_lastupdatetime, 
	    	S.operateid AS s_operateid, 
	    	S.setmentamount AS s_setmentamount, 
	    	S.money AS s_money, 
	    	S.projectid AS s_projectid, 
	    	S.del AS s_del,
	    	u.guid AS u_guid, 
	    	u.evidenceguid AS u_evidenceguid, 
	    	u.url AS u_url, 
	    	u.userguid AS u_userguid, 
	    	u.imagename AS u_imagename, 
	    	u.imagetype AS u_imagetype, 
	    	u.uploadtime AS u_uploadtime,
	    	c.shortname as companyname   
    	FROM projects T left join settlement S on T.guid=S.projectid
    	left join upimage u on T.guid=u.evidenceguid 
    	left join company c on T.companyid=c.guid 
		<include refid="WhereSQL" />
		ORDER BY T.starttime DESC 
	</select>
	
		<!-- 心税票登记查找语句 -->
	<select id="xspfind" resultMap="settlementWithProjects" parameterType="Projects" flushCache="false" >
    	SELECT 
	    	T.guid AS guid, 
	    	T.stockcompany AS stockcompany, 
	    	T.stockcompanyid AS stockcompanyid, 
	    	T.supplycompany AS supplycompany, 
	    	T.supplycompanyid AS supplycompanyid, 
	    	T.coaltype AS coaltype, 
	    	T.coalquality AS coalquality, 
	    	T.starttime AS starttime, 
	    	T.endtime AS endtime, 
	    	T.camount AS camount, 
	    	T.unitprice AS unitprice, 
	    	T.managername AS managername, 
	    	T.managerid AS managerid, 
	    	T.createdate AS createdate, 
	    	T.operateid AS operateid, 
	    	T.companyid AS companyid, 
	    	T.del AS del, 
	    	T.lastupdatetime AS lastupdatetime,
	    	S.guid AS s_guid, 
	    	S.startdate AS s_startdate, 
	    	S.enddate AS s_enddate, 
	    	S.createdate AS s_createdate, 
	    	S.lastupdatetime AS s_lastupdatetime, 
	    	S.operateid AS s_operateid, 
	    	S.setmentamount AS s_setmentamount, 
	    	S.money AS s_money, 
	    	S.projectid AS s_projectid, 
	    	S.del AS s_del,
	    	c.shortname as companyname   
    	FROM projects T left join settlement S on T.guid=S.projectid
    	left join company c on T.companyid=c.guid 
		<include refid="WhereSQL" />
		ORDER BY T.starttime DESC 
	</select>
	<!-- 发货登记信息查找语句 -->
	<select id="fhxxfind" resultMap="fhxxProjects" parameterType="Projects" flushCache="false" useCache="true">
    	SELECT 
	    	T.GUID AS guid, 
	    	T.STOCKCOMPANY AS stockcompany, 
	    	T.STOCKCOMPANYID AS stockcompanyid, 
	    	T.SUPPLYCOMPANY AS supplycompany, 
	    	T.SUPPLYCOMPANYID AS supplycompanyid, 
	    	T.COALTYPE AS coaltype, 
	    	T.COALQUALITY AS coalquality, 
	    	T.STARTTIME AS starttime, 
	    	T.ENDTIME AS endtime, 
	    	T.CAMOUNT AS camount, 
	    	T.UNITPRICE AS unitprice, 
	    	T.MANAGERNAME AS managername, 
	    	T.MANAGERID AS managerid, 
	    	T.CREATEDATE AS createdate, 
	    	T.OPERATEID AS operateid, 
	    	T.COMPANYID AS companyid, 
	    	T.DEL AS del,
            sum(f.sum) as persent,
            c.shortname as companyname 
    	FROM projects T left join fhdj f on T.guid=f.pcid  
    	left join company c on T.companyid=c.guid 
		<include refid="WhereSQL" />
		group by T.guid 
		ORDER BY T.CREATEDATE DESC 
	</select>
	<!-- 获取总记录数语句 -->
	<select id="findCount" resultType="java.lang.Integer" parameterType="Projects" flushCache="false" useCache="true">
    	SELECT COUNT(*)  FROM projects T
		<include refid="WhereSQL" />
	</select>
	
	<!-- 插入语句 -->
	<insert id="insert" parameterType="Projects" flushCache="true"> 
		INSERT INTO projects
		(
			GUID, 
			STOCKCOMPANY, 
			STOCKCOMPANYID, 
			SUPPLYCOMPANY, 
			SUPPLYCOMPANYID, 
			COALTYPE, 
			COALQUALITY, 
			STARTTIME, 
			ENDTIME, 
			CAMOUNT, 
			UNITPRICE, 
			MANAGERNAME, 
			MANAGERID, 
			CREATEDATE, 
			OPERATEID, 
			COMPANYID, 
			DEL, 
			LASTUPDATETIME 
		 ) 
		VALUES
		(
			#{guid,jdbcType=VARCHAR}, 
			#{stockcompany,jdbcType=VARCHAR}, 
			#{stockcompanyid,jdbcType=VARCHAR}, 
			#{supplycompany,jdbcType=VARCHAR}, 
			#{supplycompanyid,jdbcType=VARCHAR}, 
			#{coaltype,jdbcType=VARCHAR}, 
			#{coalquality,jdbcType=VARCHAR}, 
			#{starttime,jdbcType=TIMESTAMP}, 
			#{endtime,jdbcType=TIMESTAMP}, 
			#{camount,jdbcType=DECIMAL}, 
			#{unitprice,jdbcType=DECIMAL}, 
			#{managername,jdbcType=VARCHAR}, 
			#{managerid,jdbcType=VARCHAR}, 
			#{createdate,jdbcType=TIMESTAMP}, 
			#{operateid,jdbcType=VARCHAR}, 
			#{companyid,jdbcType=VARCHAR}, 
			#{del,jdbcType=VARCHAR}, 
			#{lastupdatetime,jdbcType=TIMESTAMP} 
		) 
	</insert>
	
	<!-- 更新语句 -->
	<update id="update"  parameterType="Projects" flushCache="true"> 
		update projects 
		<set> 
			<if test="guid != null">GUID=#{guid},</if>
			<if test="stockcompany != null">STOCKCOMPANY=#{stockcompany},</if>
			<if test="stockcompanyid != null">STOCKCOMPANYID=#{stockcompanyid},</if>
			<if test="supplycompany != null">SUPPLYCOMPANY=#{supplycompany},</if>
			<if test="supplycompanyid != null">SUPPLYCOMPANYID=#{supplycompanyid},</if>
			<if test="coaltype != null">COALTYPE=#{coaltype},</if>
			<if test="coalquality != null">COALQUALITY=#{coalquality},</if>
			<if test="starttime != null">STARTTIME=#{starttime},</if>
			<if test="endtime != null">ENDTIME=#{endtime},</if>
			<if test="camount != null">CAMOUNT=#{camount},</if>
			<if test="unitprice != null">UNITPRICE=#{unitprice},</if>
			<if test="managername != null">MANAGERNAME=#{managername},</if>
			<if test="managerid != null">MANAGERID=#{managerid},</if>
			<if test="createdate != null">CREATEDATE=#{createdate},</if>
			<if test="operateid != null">OPERATEID=#{operateid},</if>
			<if test="companyid != null">COMPANYID=#{companyid},</if>
			<if test="del != null">DEL=#{del},</if>
			<if test="lastupdatetime != null">LASTUPDATETIME=#{lastupdatetime},</if>
		</set>
		WHERE GUID = #{guid}
	</update> 
	
	<!-- 单选删除语句 -->
	<delete id="delete" parameterType="Projects" flushCache="true"> 
		DELETE FROM projects WHERE GUID = #{guid}
	</delete>
	
	<!-- 多选删除 -->
	<delete id="mulDel" parameterType="java.lang.String" flushCache="true">
		DELETE FROM projects WHERE GUID IN
		<foreach item="id" collection="array" open="(" separator="," close=")"> 
			#{id}
		</foreach> 
	</delete>
	
	<resultMap  id="settlementWithProjects" type="Projects">
			<result property="guid"  column="guid"/> 
	    	<result property="stockcompany"  column="stockcompany"/> 
	    	<result property="stockcompanyid"  column="stockcompanyid"/>
	    	<result property="supplycompany"  column="supplycompany"/> 
	    	<result property="supplycompanyid"  column="supplycompanyid"/>
	    	<result property="coaltype"  column="coaltype"/> 
	    	<result property="coalquality"  column="coalquality"/> 
	    	<result property="starttime"  column="starttime"/> 
	    	<result property="endtime"  column="endtime"/> 
	    	<result property="camount"  column="camount"/>
	    	<result property="unitprice"  column="unitprice"/> 
	    	<result property="managername"  column="managername"/> 
	    	<result property="managerid"  column="managerid"/> 
	    	<result property="createdate"  column="createdate"/>
	    	<result property="operateid"  column="operateid"/> 
	    	<result property="companyid"  column="companyid"/>
	    	<result property="del"  column="del"/> 
	    	<result property="lastupdatetime"  column="lastupdatetime"/>
	    	<result property="companyname"  column="companyname"/>
			<collection property="settlement" ofType="Settlement">
				<id property="guid" column="s_guid" />
				<result property="startdate" column="s_startdate" /> 
		    	<result property="enddate" column="s_enddate" />
		    	<result property="createdate" column="s_createdate" /> 
		    	<result property="lastupdatetime" column="s_lastupdatetime" /> 
		    	<result property="operateid" column="s_operateid" />
		    	<result property="setmentamount" column="s_setmentamount" /> 
		    	<result property="money" column="s_money" />
		    	<result property="projectid" column="s_projectid" />
		    	<result property="del" column="s_del" />  
			</collection>
			<collection property="upimage" ofType="Upimage">
				<id property="guid" column="u_guid" />
		    	<id property="evidenceguid" column="u_evidenceguid" /> 
		    	<id property="url" column="u_url" /> 
		    	<id property="userguid" column="u_userguid" />
		    	<id property="imagename" column="u_imagename" /> 
		    	<id property="imagetype" column="u_imagetype" /> 
		    	<id property="uploadtime" column="u_uploadtime" /> 
			</collection>
</resultMap>
	
	<select id="findAdvance" resultType="AdvanceCountResult" parameterType="Projects" flushCache="false" useCache="true">
    	select   
			T.guid as guid,
			T.starttime as starttime,
			T.endtime as endtime,
			T.coaltype as coaltype,
			T.coalquality as coalquality,
			T.stockcompany as stockcompany,
			T.supplycompany as supplycompany,
			sum(c.amount) as advanceamount, 
			sum(a.advancemoney) as advancemoney 
			from projects T 
			left join payrecord c 
			on T.guid =c.projectid and c.paytype ='1' and T.del=#{del} and c.del='1' 
			left join advancepay a 
			on a.projectid =T.guid and a.del='1' 
			<include refid="WhereSQL" /> 
			group by T.guid  
	</select>
	
	<!-- 查找语句 -->
	<select id="findProjects" resultType="ProjectsResult" parameterType="Projects" flushCache="false" useCache="true">
    	select    
			distinct p.guid as guid,
			p.managerid as managerid,
			p.stockcompany as stockcompany,
			p.starttime as starttime,
			p.endtime as endtime,
			p.coaltype as coaltype,
			p.coalquality as coalquality,
			p.COMPANYID AS companyid, 
			c.shortname as shortname,
			c.companytype as companytype,
			p.supplycompany as supplycompany,
			u.evidenceguid as upimageid 
			from  projects p 
			left join upimage u 
			on p.guid=u.evidenceguid 
			left join company c 
			on p.companyid =c.guid 
	</select>
	<!--报表查找语句  主体对应贸易商-->
	<select id="bbfind" resultType="java.util.HashMap" parameterType="Projects" flushCache="false" useCache="true">
		select *from reconciliation r 
		where r.c_guid=#{companyid}
		<if test="supplycompanyid != null and supplycompanyid != ''"> 
			and r.p_supplycompanyid=#{supplycompanyid}
		</if>
		and r.j_type in('','1') and p_groupdate is not null
		order by r.orderbydate
	</select>
	<!--报表查找语句  主体对应需方-->
	<select id="xffind" resultType="java.util.HashMap" parameterType="Projects" flushCache="false" useCache="true">
		select *from xfview r 
		where r.c_guid=#{companyid}
		<if test="stockcompanyid != null and stockcompanyid != ''"> 
		and r.bk_stockcompanyid=#{stockcompanyid} and 
		(r.bk_stockcompanyid=#{stockcompanyid}
		or r.j_type in('','2'))
		</if>
		and p_groupdate is not null
		order by r.orderbydate
	</select>
<!-- 	垫款余额 -->
	<select id="dkye" resultType="java.util.HashMap" parameterType="Projects" flushCache="false" useCache="true">
			select 
			T.guid as p_guid ,
			T.starttime as p_starttime,
			T.endtime as p_endtime,
			T.stockcompany as p_stockcompany,
			c.shortname as c_shortname,
			c.guid as c_guid,
			T.supplycompany as p_supplycompany ,
			IFNULL(sum(pc.amount),0) as pc_payamount,
			IFNULL(sum(a.advancemoney),0) as a_advanceamount
			from projects T 
			left join company c 
			on T.companyid =c.guid 
			left join payrecord pc 
			on T.guid=pc.projectid and pc.paytype='1' 
			left join advancepay a 
			on a.projectid = T.guid 
			<include refid="WhereSQL" />
			order by T.guid
			
	</select>
	<select id="tz" resultType="java.util.HashMap" parameterType="Projects" flushCache="false" useCache="true">
			select p.guid, p.starttime,p.endtime,p.stockcompany,p.supplycompany,p.coaltype,p.camount,p.unitprice,p.managername
			,(select count(imagetype) from upimage u where u.imagetype='1' and p.guid=u.evidenceguid) syht,
			(select count(imagetype) from upimage u where u.imagetype='2' and p.guid=u.evidenceguid) xyht,
			(select round(IfNULL(sum(s.setmentamount),0),2) from settlement s where s.projectid=p.guid) as jssl,
			(select round(IfNULL(sum(s.money),0),2) from settlement s where s.projectid=p.guid) as jsje,
			(select round(IfNULL(sum(f.sum),0),2) from fhdj f where f.pcid=p.guid) as fhsl,
			(select if(p.camount>0,round(sum(f.sum)/p.camount,2),0) from fhdj f where f.pcid=p.guid) as fhbl,
			(select round(IfNULL(sum(j.money),0),2) from jxdj j where j.projectid=p.guid and j.type='1') as jje,
			(select round(IfNULL(sum(j.money),0),2)  from jxdj j where j.projectid=p.guid and j.type='2') as xje,
			((select round(IfNULL(sum(pay.amount),0),2)  from payrecord pay where pay.projectid=p.guid and pay.paytype='1')-
			(select round(IfNULL(sum(ad.advancemoney),0),2)  from advancepay ad where ad.projectid =p.guid )) as dkye
			From projects p  where  p.del='1' and p.companyid=#{companyid}
			order by p.starttime desc,p.stockcompany asc
	</select>

	<resultMap  id="fhxxProjects" type="Projects">
			<id property="guid" column="guid" />
	    	<result property="stockcompany"  column="stockcompany"/> 
	    	<result property="stockcompanyid"  column="stockcompanyid"/>
	    	<result property="supplycompany"  column="supplycompany"/> 
	    	<result property="supplycompanyid"  column="supplycompanyid"/>
	    	<result property="coaltype"  column="coaltype"/> 
	    	<result property="coalquality"  column="coalquality"/> 
	    	<result property="starttime"  column="starttime"/> 
	    	<result property="endtime"  column="endtime"/> 
	    	<result property="camount"  column="camount"/>
	    	<result property="unitprice"  column="unitprice"/> 
	    	<result property="managername"  column="managername"/> 
	    	<result property="managerid"  column="managerid"/> 
	    	<result property="createdate"  column="createdate"/>
	    	<result property="operateid"  column="operateid"/> 
	    	<result property="companyid"  column="companyid"/>
	    	<result property="del"  column="del"/> 
	    	<result property="lastupdatetime"  column="lastupdatetime"/>
	    	<result property="persent"  column="persent"/>
	    	<result property="companyname"  column="companyname"/>
<!-- 			<collection property="fhdjs" ofType="Fhdj"> -->
<!-- 				<id property="guid" column="f_guid" /> -->
<!-- 		    	<result property="createtime"  column="s_createtime" />  -->
<!-- 		    	<result property="amount"  column="f_amount" />  -->
<!-- 		    	<result property="sum"  column="f_sum" />  -->
<!-- 		    	<result property="pcid"  column="f_pcid" />  -->
<!-- 		    	<result property="del"  column="f_del" />  -->
<!-- 		    	<result property="lastupdatetime"  column="f_lastupdatetime" />  -->
<!-- 		    	<result property="operateid"  column="f_operateid" />    -->
<!-- 			</collection> -->
</resultMap>

	<!-- 查找当前融资主体/供应商下的采购商  -->
	<select id="findStockcompany" resultType="Projects" parameterType="Projects" flushCache="false" useCache="true">
    	select 
			distinct T.stockcompanyid as stockcompanyid,
			T.stockcompany as stockcompany 
			from projects T 
			<include refid="WhereSQL" /> 
	</select>
	
	<!-- 查找当前融资主体下的供应商-->
	<select id="findSupplycompany" resultType="Projects" parameterType="Projects" flushCache="false" useCache="true">
    	select 
			distinct p.supplycompanyid as supplycompanyid,
			p.supplycompany as supplycompany 
			from projects p 
			where companyid=#{companyid}; 
	</select>
	
	<!-- 查找当前供应商下的融资主体  -->
	<select id="findCompanys" resultType="Projects" parameterType="Projects" flushCache="false" useCache="true">
    	select 
			distinct T.companyid as companyid,
			c.shortname as companyname  
			from projects T 
			left join company c 
			on T.companyid=c.guid
			<include refid="WhereSQL" /> 
	</select>
	
	
</mapper>
